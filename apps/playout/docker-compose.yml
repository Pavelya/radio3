version: '3.8'

services:
  liquidsoap:
    build: .
    container_name: radio-liquidsoap
    environment:
      # Use host.docker.internal to access API running on host machine
      - API_URL=http://host.docker.internal:8000
      - OUTPUT_DIR=/radio/audio
      - EMERGENCY_DIR=/radio/emergency
      - ICECAST_HOST=icecast
      - ICECAST_PORT=8001
      - ICECAST_PASSWORD=hackme
    volumes:
      - ./audio:/radio/audio
      - ./emergency:/radio/emergency:ro
      - ./logs:/var/log/liquidsoap
    depends_on:
      - icecast
    restart: unless-stopped
    networks:
      - radio-network
    # Enable host.docker.internal on Linux
    extra_hosts:
      - "host.docker.internal:host-gateway"

  icecast:
    image: infiniteproject/icecast:latest
    container_name: radio-icecast
    environment:
      - ICECAST_SOURCE_PASSWORD=hackme
      - ICECAST_ADMIN_PASSWORD=admin
      - ICECAST_PASSWORD=hackme
      - ICECAST_RELAY_PASSWORD=hackme
    ports:
      # Port 8001 (avoids conflict with API server on 8000)
      - "8001:8001"
    volumes:
      - ./icecast.xml:/etc/icecast.xml:ro
    restart: unless-stopped
    networks:
      - radio-network

  # Stream health monitoring
  monitor:
    image: curlimages/curl:latest
    container_name: radio-monitor
    command: sh -c "while true; do curl -s http://icecast:8001/status.xsl > /dev/null && echo '[$(date)] Stream OK' || echo '[$(date)] Stream DOWN'; sleep 30; done"
    depends_on:
      - icecast
    restart: unless-stopped
    networks:
      - radio-network

networks:
  radio-network:
    driver: bridge
